<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bangladesh Environmental Mapping System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans Bengali', sans-serif; }
    .bengali { font-family: 'Noto Sans Bengali', sans-serif; }
  </style>
</head>
<body className="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const translations = {
      en: {
        title: "Bangladesh Environmental Mapping System",
        searchPlaceholder: "Search for a place in Bangladesh (e.g., Dhaka)",
        searchButton: "Search",
        latPlaceholder: "Latitude (20–27)",
        lngPlaceholder: "Longitude (88–93)",
        useLocation: "Use My Location",
        clearData: "Clear Data",
        loading: "Loading data...",
        noData: "Click, search, or pin a location to view environmental data.",
        weather: "Weather",
        temperature: "Temperature",
        humidity: "Humidity",
        windSpeed: "Wind Speed",
        precipitation: "Precipitation",
        airQuality: "Air Quality",
        aqi: "AQI",
        pm25: "PM2.5",
        vegetation: "Vegetation",
        ndvi: "NDVI",
        vegetationHealth: "Vegetation Health",
        landCover: "Land Cover",
        type: "Type",
        floodRisk: "Flood Risk",
        level: "Level",
        waterQuality: "Water Quality",
        pH: "pH",
        turbidity: "Turbidity",
        aiSuggestions: "AI Suggestions",
        cropSuggestions: "Crop Suggestions",
        irrigationAdvice: "Irrigation Advice",
        healthTips: "Health Tips",
        errors: "Errors",
        location: "Location",
        date: "Date",
        invalidCoordinates: "Invalid coordinates for Bangladesh",
        geolocationDenied: "Geolocation access denied",
        geolocationUnsupported: "Geolocation not supported",
        locationOutside: "Clicked location outside Bangladesh",
        pinnedPlaces: "Pinned Places",
        pinLocation: "Pin Location",
        removePin: "Remove",
        clearPins: "Clear All Pins",
        noPinnedPlaces: "No pinned places yet.",
        pinnedConfirmation: "Pinned: ",
      },
      bn: {
        title: "বাংলাদেশ পরিবেশ ম্যাপিং সিস্টেম",
        searchPlaceholder: "বাংলাদেশে একটি স্থান অনুসন্ধান করুন (যেমন, ঢাকা)",
        searchButton: "অনুসন্ধান",
        latPlaceholder: "অক্ষাংশ (২০–২৭)",
        lngPlaceholder: "দ্রাঘিমাংশ (৮৮–৯৩)",
        useLocation: "আমার অবস্থান ব্যবহার করুন",
        clearData: "ডেটা মুছুন",
        loading: "ডেটা লোড হচ্ছে...",
        noData: "পরিবেশ ডেটা দেখতে মানচিত্রে ক্লিক করুন, অনুসন্ধান করুন বা একটি স্থান পিন করুন।",
        weather: "আবহাওয়া",
        temperature: "তাপমাত্রা",
        humidity: "আর্দ্রতা",
        windSpeed: "বাতাসের গতি",
        precipitation: "বৃষ্টিপাত",
        airQuality: "বায়ুর গুণমান",
        aqi: "AQI",
        pm25: "PM2.5",
        vegetation: "গাছপালা",
        ndvi: "NDVI",
        vegetationHealth: "গাছপালার স্বাস্থ্য",
        landCover: "ভূমি আচ্ছাদন",
        type: "প্রকার",
        floodRisk: "বন্যার ঝুঁকি",
        level: "মাত্রা",
        waterQuality: "জলের গুণমান",
        pH: "pH",
        turbidity: "টার্বিডিটি",
        aiSuggestions: "AI পরামর্শ",
        cropSuggestions: "ফসলের পরামর্শ",
        irrigationAdvice: "সেচের পরামর্শ",
        healthTips: "স্বাস্থ্য টিপস",
        errors: "ত্রুটি",
        location: "অবস্থান",
        date: "তারিখ",
        invalidCoordinates: "বাংলাদেশের জন্য অবৈধ স্থানাঙ্ক",
        geolocationDenied: "জিওলোকেশন অ্যাক্সেস প্রত্যাখ্যান করা হয়েছে",
        geolocationUnsupported: "জিওলোকেশন সমর্থিত নয়",
        locationOutside: "ক্লিক করা অবস্থান বাংলাদেশের বাইরে",
        pinnedPlaces: "পিন করা স্থান",
        pinLocation: "স্থান পিন করুন",
        removePin: "মুছুন",
        clearPins: "সব পিন মুছুন",
        noPinnedPlaces: "এখনো কোনো পিন করা স্থান নেই।",
        pinnedConfirmation: "পিন করা হয়েছে: ",
      },
    };

    const Dashboard = () => {
      const [map, setMap] = useState(null);
      const [marker, setMarker] = useState(null);
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [lat, setLat] = useState('');
      const [lng, setLng] = useState('');
      const [errors, setErrors] = useState([]);
      const [language, setLanguage] = useState('en');
      const [pinnedPlaces, setPinnedPlaces] = useState(() => {
        const saved = localStorage.getItem('pinnedPlaces');
        return saved ? JSON.parse(saved) : [];
      });
      const [placeName, setPlaceName] = useState('');
      const [pinConfirmation, setPinConfirmation] = useState('');
      const t = translations[language];

      // Save pinned places to localStorage
      useEffect(() => {
        localStorage.setItem('pinnedPlaces', JSON.stringify(pinnedPlaces));
      }, [pinnedPlaces]);

      // Clear pin confirmation after 3 seconds
      useEffect(() => {
        if (pinConfirmation) {
          const timer = setTimeout(() => setPinConfirmation(''), 3000);
          return () => clearTimeout(timer);
        }
      }, [pinConfirmation]);

      // Mock AI-based suggestions and environmental data
      const getMockData = (lat, lng) => {
        const isUrban = lat > 23.7 && lat < 23.9 && lng > 90.3 && lng < 90.5; // Approximate Dhaka area
        return {
          ndvi: (Math.random() * (0.9 - 0.2) + 0.2).toFixed(2),
          vegetationHealth: Math.random() > 0.6 ? 'Healthy' : 'Stressed',
          landCover: ['Forest', 'Cropland', 'Urban', 'Water', 'Wetland'][Math.floor(Math.random() * 5)],
          floodRisk: Math.random() > 0.7 ? 'High' : Math.random() > 0.4 ? 'Moderate' : 'Low',
          pH: (Math.random() * (8.5 - 6.5) + 6.5).toFixed(1),
          turbidity: (Math.random() * (50 - 10) + 10).toFixed(0),
          cropSuggestions: isUrban ? 'Vegetables (tomato, spinach)' : 'Rice, Jute, Maize',
          irrigationAdvice: Math.random() > 0.5 ? 'Use drip irrigation for dry soil' : 'Monitor rainfall for flood irrigation',
          healthTips: isUrban ? 'Wear masks due to high AQI' : 'Stay hydrated in humid conditions',
        };
      };

      // Retry logic for API calls
      const fetchWithRetry = async (url, retries = 3, delay = 1000) => {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(url, { headers: { 'User-Agent': 'BangladeshDashboard/1.0' } });
            if (response.ok) return await response.json();
            throw new Error(`HTTP ${response.status}`);
          } catch (err) {
            if (i === retries - 1) throw err;
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      };

      // Fetch weather data from Open-Meteo
      const fetchWeatherData = async (lat, lng) => {
        try {
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lng)}¤t=temperature_2m,relative_humidity_2m,wind_speed_10m,precipitation`;
          const data = await fetchWithRetry(url);
          return {
            temperature: data.current.temperature_2m,
            humidity: data.current.relative_humidity_2m,
            windSpeed: data.current.wind_speed_10m,
            precipitation: data.current.precipitation,
          };
        } catch (err) {
          setErrors(prev => [...prev, `${t.weather}: Failed to fetch (${err.message})`]);
          return { error: `${t.weather} data unavailable` };
        }
      };

      // Fetch air quality from AQICN (replace 'YOUR_AQICN_TOKEN' with actual token)
      const fetchAirQualityData = async (lat, lng) => {
        try {
          const response = await fetch(
            `https://api.waqi.info/feed/geo:${encodeURIComponent(lat)};${encodeURIComponent(lng)}/?token=YOUR_AQICN_TOKEN`
          );
          if (!response.ok) throw new Error('Air Quality API error');
          const airQuality = await response.json();
          if (airQuality.status !== 'ok') {
            return { error: 'No air quality data nearby' };
          }
          return {
            aqi: airQuality.data.aqi || 'N/A',
            pm25: airQuality.data.iaqi.pm25?.v || 'N/A',
          };
        } catch (err) {
          setErrors(prev => [...prev, `${t.airQuality}: Failed to fetch`]);
          return { error: `${t.airQuality} data unavailable` };
        }
      };

      // Fetch data for a location
      const fetchData = async (lat, lng, name = '') => {
        setLoading(true);
        setErrors([]);
        setPlaceName(name);
        try {
          const [weatherData, airQualityData] = await Promise.all([
            fetchWeatherData(lat, lng),
            fetchAirQualityData(lat, lng),
          ]);
          const mockData = getMockData(lat, lng);
          setData({
            lat: lat.toFixed(4),
            lng: lng.toFixed(4),
            date: new Date().toISOString().split('T')[0],
            ...weatherData,
            ...airQualityData,
            ...mockData,
          });
        } catch (err) {
          setErrors(prev => [...prev, 'General: Failed to fetch data']);
          setData({
            lat: lat.toFixed(4),
            lng: lng.toFixed(4),
            date: new Date().toISOString().split('T')[0],
            ...getMockData(lat, lng),
          });
        } finally {
          setLoading(false);
        }
      };

      // Search for a place in Bangladesh using Nominatim
      const handleSearch = async (e) => {
        e.preventDefault();
        if (!searchQuery) return;
        setLoading(true);
        setErrors([]);
        try {
          const data = await fetchWithRetry(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=bd&limit=1`
          );
          if (data.length === 0) throw new Error('No results found');
          const { lat, lon, display_name } = data[0];
          const latitude = parseFloat(lat);
          const longitude = parseFloat(lon);
          updateMap(latitude, longitude);
          await fetchData(latitude, longitude, display_name);
        } catch (err) {
          setErrors(prev => [...prev, `Search: ${err.message}`]);
        } finally {
          setLoading(false);
        }
      };

      // Handle coordinate input
      const handleCoordinateSubmit = (e) => {
        e.preventDefault();
        const latitude = parseFloat(lat);
        const longitude = parseFloat(lng);
        if (
          isNaN(latitude) || isNaN(longitude) ||
          latitude < 20 || latitude > 27 ||
          longitude < 88 || longitude > 93
        ) {
          setErrors(prev => [...prev, t.invalidCoordinates]);
          return;
        }
        updateMap(latitude, longitude);
        fetchData(latitude, longitude, `(${latitude.toFixed(4)}, ${longitude.toFixed(4)})`);
      };

      // Use geolocation
      const handleUseLocation = () => {
        setLoading(true);
        setErrors([]);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              if (latitude >= 20 && latitude <= 27 && longitude >= 88 && longitude <= 93) {
                updateMap(latitude, longitude);
                fetchData(latitude, longitude, 'Current Location');
              } else {
                setErrors(prev => [...prev, t.locationOutside]);
                updateMap(23.685, 90.3563);
                fetchData(23.685, 90.3563, 'Dhaka (Fallback)');
              }
            },
            () => {
              setErrors(prev => [...prev, t.geolocationDenied]);
              updateMap(23.685, 90.3563);
              fetchData(23.685, 90.3563, 'Dhaka (Fallback)');
            }
          );
        } else {
          setErrors(prev => [...prev, t.geolocationUnsupported]);
          setLoading(false);
        }
      };

      // Pin current location
      const handlePinLocation = () => {
        if (!data) return;
        const newPin = {
          name: placeName || `(${data.lat}, ${data.lng})`,
          lat: parseFloat(data.lat),
          lng: parseFloat(data.lng),
        };
        setPinnedPlaces(prev => [...prev, newPin]);
        setPinConfirmation(`${t.pinnedConfirmation}${newPin.name}`);
      };

      // Remove a pinned place
      const handleRemovePin = (index) => {
        setPinnedPlaces(prev => prev.filter((_, i) => i !== index));
      };

      // Clear all pinned places
      const handleClearPins = () => {
        setPinnedPlaces([]);
      };

      // View a pinned place
      const handleViewPin = (pin) => {
        updateMap(pin.lat, pin.lng);
        fetchData(pin.lat, pin.lng, pin.name);
      };

      // Update map with new marker
      const updateMap = (latitude, longitude) => {
        if (marker) map.removeLayer(marker);
        const newMarker = L.marker([latitude, longitude]).addTo(map);
        setMarker(newMarker);
        map.setView([latitude, longitude], 10);
      };

      // Initialize map
      useEffect(() => {
        const leafletMap = L.map('map').setView([23.685, 90.3563], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(leafletMap);

        leafletMap.on('click', (e) => {
          const { lat, lng } = e.latlng;
          if (lat >= 20 && lat <= 27 && lng >= 88 && lng <= 93) {
            updateMap(lat, lng);
            fetchData(lat, lng, `(${lat.toFixed(4)}, ${lng.toFixed(4)})`);
          } else {
            setErrors(prev => [...prev, t.locationOutside]);
          }
        });

        setMap(leafletMap);
        return () => leafletMap.remove();
      }, []);

      return (
        <div className="min-h-screen bg-white text-gray-800">
          <div className="container mx-auto p-6">
            <div className="flex justify-between items-center mb-6">
              <h1 className={`text-3xl font-bold ${language === 'bn' ? 'bengali' : ''}`}>
                {t.title}
              </h1>
              <select
                className="p-2 border rounded-md"
                value={language}
                onChange={(e) => setLanguage(e.target.value)}
              >
                <option value="en">English</option>
                <option value="bn">বাংলা</option>
              </select>
            </div>
            <div className="flex flex-col md:flex-row gap-6">
              {/* Map Section */}
              <div className="md:w-2/3 bg-gray-50 rounded-lg shadow-lg">
                <div id="map" className="h-[600px] rounded-lg"></div>
              </div>
              {/* Sidebar */}
              <div className="md:w-1/3 bg-gray-50 p-6 rounded-lg shadow-lg">
                {/* Search and Coordinates */}
                <form onSubmit={handleSearch} className="mb-4">
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder={t.searchPlaceholder}
                    className={`w-full p-3 border rounded-md mb-2 ${language === 'bn' ? 'bengali' : ''}`}
                  />
                  <button
                    type="submit"
                    className="w-full bg-teal-500 text-white p-3 rounded-md hover:bg-teal-600"
                    disabled={loading}
                  >
                    {t.searchButton}
                  </button>
                </form>
                <form onSubmit={handleCoordinateSubmit} className="mb-4">
                  <div className="flex gap-2">
                    <input
                      type="number"
                      value={lat}
                      onChange={(e) => setLat(e.target.value)}
                      placeholder={t.latPlaceholder}
                      className={`flex-1 p-3 border rounded-md ${language === 'bn' ? 'bengali' : ''}`}
                      step="any"
                    />
                    <input
                      type="number"
                      value={lng}
                      onChange={(e) => setLng(e.target.value)}
                      placeholder={t.lngPlaceholder}
                      className={`flex-1 p-3 border rounded-md ${language === 'bn' ? 'bengali' : ''}`}
                      step="any"
                    />
                  </div>
                  <button
                    type="submit"
                    className="w-full bg-teal-500 text-white p-3 rounded-md hover:bg-teal-600 mt-2"
                    disabled={loading}
                  >
                    {t.searchButton}
                  </button>
                  <button
                    type="button"
                    onClick={handleUseLocation}
                    className="w-full bg-gray-500 text-white p-3 rounded-md hover:bg-gray-600 mt-2"
                    disabled={loading}
                  >
                    {t.useLocation}
                  </button>
                </form>
                {/* Pinned Places */}
                <div className="mb-4">
                  <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.pinnedPlaces}</h3>
                  {pinConfirmation && (
                    <p className={`text-green-600 mt-2 ${language === 'bn' ? 'bengali' : ''}`}>
                      {pinConfirmation}
                    </p>
                  )}
                  {pinnedPlaces.length > 0 ? (
                    <div className="mt-2 space-y-2">
                      {pinnedPlaces.map((pin, index) => (
                        <div key={index} className="flex justify-between items-center bg-gray-100 p-2 rounded-md">
                          <button
                            onClick={() => handleViewPin(pin)}
                            className={`text-left ${language === 'bn' ? 'bengali' : ''}`}
                          >
                            {pin.name}
                          </button>
                          <button
                            onClick={() => handleRemovePin(index)}
                            className="text-red-500 hover:text-red-700"
                          >
                            {t.removePin}
                          </button>
                        </div>
                      ))}
                      <button
                        onClick={handleClearPins}
                        className="w-full bg-red-500 text-white p-2 rounded-md hover:bg-red-600 mt-2"
                      >
                        {t.clearPins}
                      </button>
                    </div>
                  ) : (
                    <p className={language === 'bn' ? 'bengali' : ''}>{t.noPinnedPlaces}</p>
                  )}
                </div>
                {/* Data Display */}
                <div>
                  {errors.length > 0 && (
                    <div className="bg-red-100 text-red-600 p-3 rounded-md mb-4">
                      <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.errors}</h3>
                      {errors.map((err, i) => (
                        <p key={i} className={language === 'bn' ? 'bengali' : ''}>{err}</p>
                      ))}
                    </div>
                  )}
                  {loading ? (
                    <p className={language === 'bn' ? 'bengali' : ''}>{t.loading}</p>
                  ) : data ? (
                    <div className="space-y-4">
                      <div>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.location}:</strong> ({data.lat}, {data.lng})
                        </p>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.date}:</strong> {data.date}
                        </p>
                        <button
                          onClick={handlePinLocation}
                          className="w-full bg-teal-500 text-white p-3 rounded-md hover:bg-teal-600 mt-2"
                        >
                          {t.pinLocation}
                        </button>
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.weather}</h3>
                        {data.weatherError ? (
                          <p className={language === 'bn' ? 'bengali' : ''}>{data.weatherError}</p>
                        ) : (
                          <>
                            <p className={language === 'bn' ? 'bengali' : ''}>
                              <strong>{t.temperature}:</strong> {data.temperature}°C
                            </p>
                            <p className={language === 'bn' ? 'bengali' : ''}>
                              <strong>{t.humidity}:</strong> {data.humidity}%
                            </p>
                            <p className={language === 'bn' ? 'bengali' : ''}>
                              <strong>{t.windSpeed}:</strong> {data.windSpeed} km/h
                            </p>
                            <p className={language === 'bn' ? 'bengali' : ''}>
                              <strong>{t.precipitation}:</strong> {data.precipitation} mm
                            </p>
                          </>
                        )}
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.airQuality}</h3>
                        {data.airQualityError ? (
                          <p className={language === 'bn' ? 'bengali' : ''}>{data.airQualityError}</p>
                        ) : (
                          <>
                            <p className={language === 'bn' ? 'bengali' : ''}>
                              <strong>{t.aqi}:</strong> {data.aqi}
                            </p>
                            <p className={language === 'bn' ? 'bengali' : ''}>
                              <strong>{t.pm25}:</strong> {data.pm25} µg/m³
                            </p>
                          </>
                        )}
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.vegetation}</h3>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.ndvi}:</strong> {data.ndvi}
                        </p>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.vegetationHealth}:</strong> {data.vegetationHealth}
                        </p>
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.landCover}</h3>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.type}:</strong> {data.landCover}
                        </p>
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.floodRisk}</h3>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.level}:</strong> {data.floodRisk}
                        </p>
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.waterQuality}</h3>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.pH}:</strong> {data.pH}
                        </p>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.turbidity}:</strong> {data.turbidity} NTU
                        </p>
                      </div>
                      <div className="border-t pt-2">
                        <h3 className={`font-semibold ${language === 'bn' ? 'bengali' : ''}`}>{t.aiSuggestions}</h3>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.cropSuggestions}:</strong> {data.cropSuggestions}
                        </p>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.irrigationAdvice}:</strong> {data.irrigationAdvice}
                        </p>
                        <p className={language === 'bn' ? 'bengali' : ''}>
                          <strong>{t.healthTips}:</strong> {data.healthTips}
                        </p>
                      </div>
                      <button
                        onClick={() => setData(null)}
                        className="w-full bg-teal-500 text-white p-3 rounded-md hover:bg-teal-600 mt-4"
                      >
                        {t.clearData}
                      </button>
                    </div>
                  ) : (
                    <p className={language === 'bn' ? 'bengali' : ''}>{t.noData}</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<Dashboard />, document.getElementById('root'));
  </script>
</body>
</html>